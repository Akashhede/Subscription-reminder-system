
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Subscription Reminder System</title>
   
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f6f8fa; padding:30px; }
    .card { border-radius:12px; box-shadow:0 6px 18px rgba(20,30,50,0.06); }
    
  </style>
</head>
<body>
 

<div class="container">
  <div class="text-center mb-4">
    <h1 class="text-primary">üîî Subscription Reminder System</h1>
    <p class="text-muted">Get notified 10 days before expiry (Email & WhatsApp)</p>
    <div>
      <a href="email_settings.html" class="btn btn-outline-primary btn-sm">üìß Email Settings</a>
      <a href="database_viewer.html" class="btn btn-outline-info btn-sm">üìä Database Viewer</a>
      <button class="btn btn-outline-secondary btn-sm" onclick="logout()">üîí Logout</button>
    </div>
  </div>

  <div class="card p-4 mb-4">
    <h5>Add New Subscription</h5>
    <form id="addForm" class="row g-3">
      <div class="col-md-4">
        <input id="name" class="form-control" placeholder="e.g. Netflix, Spotify" required>
      </div>
      <div class="col-md-3">
        <input id="date" type="date" class="form-control" required>
      </div>
      <div class="col-md-3">
        <input id="note" class="form-control" placeholder="Optional note">
      </div>
      <div class="col-md-2 text-end">
        <button class="btn btn-primary" id="addBtn">Add Subscription</button>
      </div>
    </form>
  </div>

  <div class="card p-3">
    <h5>Current Subscriptions</h5>
    <table class="table" id="subsTable">
      <thead><tr><th>Name</th><th>Renewal Date</th><th>Note</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
// Main dashboard - requires valid JWT token
const API = "http://localhost:8000";
let token = localStorage.getItem("token") || "";

// Validate token on page load
async function validateToken() {
  if (!token) {
    alert("Session expired. Please login again.");
    window.location.href = "Login.html";
    return false;
  }
  try {
    const res = await fetch(API + "/auth/profile", {
      headers: { "Authorization": "Bearer " + token }
    });
    if (res.status === 401) {
      localStorage.removeItem("token");
      alert("Session expired. Please login again.");
      window.location.href = "Login.html";
      return false;
    }
    return true;
  } catch (e) {
    console.error("Token validation error:", e);
    return true;
  }
}

// Logout function (shared with other pages)
function logout(){
  localStorage.removeItem('token');
  window.location.href = 'login.html';
}

async function listSubs(){
  if(!token){ document.querySelector("#subsTable tbody").innerHTML = "<tr><td colspan='4'>Please login (use /auth/register and /auth/login)</td></tr>"; return;}
  const res = await fetch(API + "/subscription/list", { headers: { "Authorization": "Bearer " + token }});
  if(res.status !== 200){ document.querySelector("#subsTable tbody").innerHTML = "<tr><td colspan='4'>Auth error or no subs</td></tr>"; return;}
  const data = await res.json();
  const body = document.querySelector("#subsTable tbody");
  body.innerHTML = "";
  data.forEach(s => {
    const r = document.createElement("tr");
    r.innerHTML = `
      <td>${s.name}</td>
      <td>${s.renewal_date}</td>
      <td>${s.note || "-"}</td>
      <td>
        <button class="btn btn-sm btn-warning" onclick="sendEmailAlert(${s.id})">üìß Send Alert</button>
        <button class="btn btn-sm btn-danger" onclick="deleteSub(${s.id})">üóëÔ∏è Delete</button>
      </td>
    `;
    body.appendChild(r);
  });
}

async function sendEmailAlert(subId) {
  if(!token){ alert("Not authenticated"); return; }
  const res = await fetch(API + "/subscription/send-alert/" + subId, {
    method: "POST",
    headers: {"Authorization": "Bearer " + token}
  });
  if(res.ok) {
    const data = await res.json();
    alert(data.message);
  } else {
    alert("Failed to send alert: " + (await res.text()));
  }
}

async function deleteSub(subId) {
  if(!confirm("Delete this subscription?")) return;
  if(!token){ alert("Not authenticated"); return; }
  const res = await fetch(API + "/subscription/delete/" + subId, {
    method: "DELETE",
    headers: {"Authorization": "Bearer " + token}
  });
  if(res.ok) {
    alert("Deleted");
    listSubs();
  } else {
    alert("Failed to delete: " + (await res.text()));
  }
}

document.getElementById("addForm").onsubmit = async (e) => {
  e.preventDefault();
  token = localStorage.getItem("token") || "";
  if(!token){ alert("No auth token found. Register/login first."); return; }
  const name = document.getElementById("name").value;
  const date = document.getElementById("date").value;
  const note = document.getElementById("note").value;
  const res = await fetch(API + "/subscription/add", {
    method: "POST",
    headers: {"Content-Type":"application/json","Authorization":"Bearer " + token},
    body: JSON.stringify({ name, renewal_date: date, note })
  });
  if(res.ok){ 
    alert("Added"); 
    document.getElementById("addForm").reset(); 
    listSubs(); 
  } else { 
    try {
      const errData = await res.json();
      if (res.status === 401) {
        localStorage.removeItem("token");
        token = "";
        alert("Session expired. Please login again.");
        window.location.href = "Login.html";
      } else {
        alert("Failed to add: " + (errData.detail || errData.message || "Unknown error"));
      }
    } catch (e) {
      alert("Failed to add subscription");
    }
  }
}

window.addEventListener("load", async () => {
  await validateToken();
  listSubs();
});
</script>

</body>
</html>
